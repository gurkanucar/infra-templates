name: Build and Deploy Java (Multi-Stage)

on:
  push:
    branches: 
      - "main"  
      - "develop"       # Develop
      - "test"          # Test
      - "release/*"     # UAT
    tags:
      - "v*.*.*"        # Prod

jobs:
  setup:
    runs-on: self-hosted
    outputs:
      env_name: ${{ steps.calc.outputs.env_name }}
      kube_ns: ${{ steps.calc.outputs.kube_ns }}
      version: ${{ steps.calc.outputs.version }}
      docker_tag: ${{ steps.calc.outputs.docker_tag }}
      app_name: ${{ steps.calc.outputs.app_name }}
    steps:
      - name: Calculate Vars
        id: calc
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          BASE_APP_NAME="spring-boot-app"

          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # --- PRODUCTION ---
            echo "env_name=prod" >> $GITHUB_OUTPUT
            echo "kube_ns=default" >> $GITHUB_OUTPUT
            VERSION=${GITHUB_REF#refs/tags/}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "docker_tag=$VERSION" >> $GITHUB_OUTPUT
            echo "app_name=$BASE_APP_NAME" >> $GITHUB_OUTPUT
            
          elif [[ $GITHUB_REF == refs/heads/release/* ]]; then
            # --- UAT ---
            echo "env_name=uat" >> $GITHUB_OUTPUT
            echo "kube_ns=uat" >> $GITHUB_OUTPUT
            VERSION=${GITHUB_REF#refs/heads/release/}
            echo "version=$VERSION-rc.${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "docker_tag=uat-latest" >> $GITHUB_OUTPUT
            echo "app_name=${BASE_APP_NAME}-uat" >> $GITHUB_OUTPUT
        
          elif [[ $GITHUB_REF == refs/heads/test ]]; then
            # --- TEST ---
            echo "env_name=test" >> $GITHUB_OUTPUT
            echo "kube_ns=test" >> $GITHUB_OUTPUT
            echo "version=0.0.0-test.${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "docker_tag=test-latest" >> $GITHUB_OUTPUT
            echo "app_name=${BASE_APP_NAME}-test" >> $GITHUB_OUTPUT

          else
            # --- DEVELOP ---
            echo "env_name=develop" >> $GITHUB_OUTPUT
            echo "kube_ns=develop" >> $GITHUB_OUTPUT
            echo "version=0.0.0-develop.${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "docker_tag=develop-latest" >> $GITHUB_OUTPUT
            echo "app_name=${BASE_APP_NAME}-dev" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: setup
    runs-on: self-hosted
    environment: ${{ needs.setup.outputs.env_name }}

    steps:
      - name: Checkout App Code
        uses: actions/checkout@v4
        with:
          path: src

      - name: Checkout Charts Library
        uses: actions/checkout@v4
        with:
          repository: gurkanucar/infra-templates
          path: charts
          # token: ${{ secrets.GH_PAT_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./src
          push: true
          tags: |
            127.0.0.1:5000/spring-boot-app:${{ needs.setup.outputs.docker_tag }}
            127.0.0.1:5000/spring-boot-app:${{ github.sha }}
            127.0.0.1:5000/spring-boot-app:${{ needs.setup.outputs.version }}

      - name: Deploy to K3s using Helm
        run: |
          ENV_NAME="${{ needs.setup.outputs.env_name }}"
          KUBE_NS="${{ needs.setup.outputs.kube_ns }}"
          VERSION="${{ needs.setup.outputs.version }}"
          APP_NAME="${{ needs.setup.outputs.app_name }}"
          
          VALUES_FILE="./src/deploy/$ENV_NAME/values.yaml"
          
          if [ -f "./src/deploy/$ENV_NAME/application.yaml" ]; then
            CONFIG_FILE="./src/deploy/$ENV_NAME/application.yaml"
            echo "Found Spring Boot YAML config."
          elif [ -f "./src/deploy/$ENV_NAME/application.properties" ]; then
            CONFIG_FILE="./src/deploy/$ENV_NAME/application.properties"
            echo "Found Spring Boot Properties config."
          else
            echo "Error: No application.yaml or application.properties found!"
            exit 1
          fi

          ls -la $VALUES_FILE
          ls -la $CONFIG_FILE

          helm upgrade --install $APP_NAME ./charts \
            --namespace $KUBE_NS \
            --create-namespace \
            -f $VALUES_FILE \
            --set appName=$APP_NAME \
            --set appVersion=$VERSION \
            --set image.repository="127.0.0.1:5000/spring-boot-app" \
            --set image.tag=$VERSION \
            --set-file appConfig=$CONFIG_FILE \
            --set env.GIT_COMMIT_SHA="${{ github.sha }}" \
            --set secrets.SPRING_DATASOURCE_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --set secrets.JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --wait \
            --timeout 5m \
            --debug